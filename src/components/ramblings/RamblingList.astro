---
import { DateTime } from "luxon";
import type { RamblingSummary } from "utils/ramblings";
import TimelineGroup from "components/notes/TimelineGroup.astro";

type Props = {
  highlightNew?: boolean;
  ramblings: RamblingSummary[];
};

const { highlightNew = false, ramblings = [] } = Astro.props;

const isNew = (rambling: RamblingSummary) =>
  highlightNew &&
  !!rambling.publishedAt &&
  DateTime.now().minus({ days: 3 }) <
    DateTime.fromISO(rambling.publishedAt, { zone: "utc" });

const formatDate = (iso?: string) =>
  iso
    ? DateTime.fromISO(iso, { zone: "utc" }).toFormat("yyyy-LL-dd")
    : "";

const getMonthLabel = (rambling: RamblingSummary) =>
  rambling.publishedAt
    ? DateTime.fromISO(rambling.publishedAt, { zone: "utc" }).toFormat("LLLL yyyy")
    : "Unpublished";

const getMonthGroups = (ramblings: RamblingSummary[]) => {
  const groups: { label: string; ramblings: RamblingSummary[] }[] = [];

  ramblings.forEach((rambling) => {
    const label = getMonthLabel(rambling);
    const currentGroup = groups[groups.length - 1];

    if (!currentGroup || currentGroup.label !== label) {
      groups.push({ label, ramblings: [rambling] });
      return;
    }

    currentGroup.ramblings.push(rambling);
  });

  return groups;
};
---

{ramblings.length === 0 ? (
  <p class="text-lg">Nothing here yet.</p>
) : (
  <ul class="w-full flex flex-col gap-0">
    {getMonthGroups(ramblings).map((group) => (
      <TimelineGroup header={group.label}>
        <ul class="flex flex-col gap-3">
          {group.ramblings.map((rambling) => (
            <li>
              <a
                href={`/ramblings/${rambling.path}`}
                class="group block nounderline text-lg leading-tight text-fg-2/70"
              >
                <span class="text-blue-300 group-hover:text-blue-400 group-hover:underline">
                  {rambling.title}
                </span>
              </a>
            </li>
          ))}
        </ul>
      </TimelineGroup>
    ))}
  </ul>
)}
